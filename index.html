<!DOCTYPE html>
<html>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title> - live polar data - </title>
<script type='text/javascript' src='/jquery/dist/jquery.min.js'></script>
<!-- <script src="polar.js"></script> -->
<link rel="stylesheet" type="text/css" href="/bootstrap/dist/css/bootstrap.min.css"> <style type='text/css'> </style>
<body bgcolor="black">
  <script type='text/javascript'>

  var night = {
    chart: {
      backgroundColor: {
        linearGradient: [0, 0, 250, 500],
        stops: [
          [0, 'rgb(255, 0, 0)'],
          [1, 'rgb(0, 0, 0)']
        ]
      }
    }
  }
  var polarDesign309 = [[0,0],[44.4,3.8],[52,4.19],[60,4.47],[75,4.71],[90,4.65],[110,4.52],[120,4.35],[135,3.81],[150,3.29],[152,3.23]];
  var polarDesign411 = [[0,0],[42.7,4.45],[52,4.98],[60,5.29],[75,5.56],[90,5.49],[110,5.47],[120,5.28],[135,4.72],[150,4.21],[167.7,3.78]];
  var polarDesign514 = [[0,0],[42.8,5.03],[52,5.62],[60,5.88],[75,6.06],[90,6.09],[110,6.09],[120,5.97],[135,5.53],[150,4.99],[167.7,4.55]];
  var polarDesign617 = [[0,0],[42.4,5.5],[52,6.01],[60,6.19],[75,6.32],[90,6.41],[110,6.41],[120,6.3],[135,6.06],[150,5.69],[174.4,5.16]];
  var polarDesign720 = [[0,0],[40.8,5.67],[52,6.21],[60,6.38],[75,6.53],[90,6.67],[110,6.69],[120,6.55],[135,6.36],[150,6.12],[177.5,5.75]];
  var polarDesign823 = [[0,0],[39.9,5.74],[52,6.29],[60,6.48],[75,6.72],[90,6.83],[110,6.99],[120,6.84],[135,6.63],[150,6.4],[179.3,6.14]];
  var polarDesign1029 = [[0,0],[39.6,5.8],[52,6.34],[60,6.56],[75,6.95],[90,7.13],[110,7.52],[120,7.43],[135,7.21],[150,6.95],[179.4,6.67]];

  //to be updated once every second?:
  var current = [];
  //updated only on refresh:
  var portPolar = [];
  var stbPolar = [];
  var polarCombined = [];

  var tackAngle
  var reachAngle

  var windSpeed = 5.8;
  var windRange = 0.2;

  var nightmode = false;

  function getWind() {
    (async() => {
      try {
        var response = await fetch("/signalk/v1/api/vessels/self/environment/wind/speedTrue/value");
        windSpeed = await response.json();
        //console.log("wind speed: " + windSpeed)
      } catch (e) {
        console.log("Error fetching wind speed")
      }
    })()
    return windSpeed;
  };


  $(function () {

    Highcharts.setOptions({
      global : {
        useUTC : false
      }
    });

    $('#container').highcharts({

      chart: {
        animation: false,//to remove flickering on axis labels
        //borderWidth: 2,
        marginLeft: 50,
        //marginTop: 100,
        polar: true,
        events: {
          load: function () {
            var chart;
            var plotLine = this.xAxis.plotLines;

            // set up the updating of the plotlines each 5 seconds
            setInterval(function () {

              chart = $('#container').highcharts();
              (async() => {
                try {
                  var response = await fetch("/signalk/v1/api/vessels/self/performance/beatAngle/value");
                  var x = await response.json();
                  tackAngle = Math.abs(x/3.14*180);

                  response = await fetch("/signalk/v1/api/vessels/self/performance/gybeAngle/value");
                  var y = await response.json();
                  reachAngle = Math.abs(y/3.14*180);

                } catch (e) {
                  console.log("Error fetching beat and gybe angles")
                }

                chart.xAxis[0].removePlotLine('tack');
                chart.xAxis[0].removePlotLine('reach');
                chart.xAxis[0].addPlotLine({
                  color: 'red', // Color value
                  dashStyle: 'shortdashdot', // Style of the plot line. Default to solid
                  value: tackAngle,//getTarget().Tack, // Value of where the line will appear
                  width: 2, // Width of the line
                  id: 'tack',
                  label: {
                    text: 'Target tack '+tackAngle.toFixed(2)+ '°',
                    verticalAlign: 'center',
                    textAlign: 'right',
                    rotation: 90,//rotation: tackAngle-90,
                    //y: 12,
                    x: 0//120
                  }
                });
                chart.xAxis[0].addPlotLine({
                  color: 'red', // Color value
                  dashStyle: 'shortdashdot', // Style of the plot line. Default to solid
                  value: reachAngle,//getTarget().Tack, // Value of where the line will appear
                  width: 2, // Width of the line
                  id: 'reach',
                  label: {
                    text: 'Target reach '+reachAngle.toFixed(2)+ '°',
                    verticalAlign: 'right',
                    textAlign: 'top',
                    rotation: 90,//rotation: reachAngle-90,
                    //y: 12,
                    x: 0//20
                  }
                });
              })();
            }, 5000);

            // set up the updating of the chart each second

            var series = this.series[10];
            var seriess = this.series;
            setInterval(function () {
              var subTitle = getWind().toFixed(2)+' +/-'+windRange+' m/s';
              //alert(subTitle);
              chart.setTitle(null, {text: subTitle});

              (async() => {
                try {
                  var response = await fetch("/signalk/v1/api/vessels/self/environment/wind/angleTrueWater/value");
                  var x = await response.json();
                  var xDegAbs = Math.abs(x/3.14*180);
                  response = await fetch("/signalk/v1/api/vessels/self/navigation/speedThroughWater/value");
                  var y = await response.json();
                  var yKnots = y/1852*3600;
                  //console.log(xDegAbs + " " + yKnots);
                  series.addPoint([xDegAbs, yKnots], true, true);
                } catch (e) {
                  console.log("Error fetching wind angle and boat speed")
                }
              })();

              /*
              $.getJSON('current', function(jsondata) {//must reside in /var/www
              x = JSON.parse(jsondata.winddir);
              y = JSON.parse(jsondata.boatspeed);
              //alert(x, '  ', y)
              series.addPoint([x, y], true, true);

              if (windSpeed < 4.11) {
              for (var i = 3; i < 10; i++) {
              seriess[i].hide();
            }
            seriess[3].show();
          } else if (windSpeed < 4.11 && windSpeed > 3.09) {
          for (var i = 3; i < 10; i++) {
          seriess[i].hide();
        }
        seriess[3].show();
        seriess[4].show();
      } else if (windSpeed < 5.14 && windSpeed > 4.11) {
      for (var i = 3; i < 10; i++) {
      seriess[i].hide();
    }
    seriess[4].show();
    seriess[5].show();
  } else if (windSpeed < 6.17 && windSpeed > 5.14) {
  for (var i = 3; i < 10; i++) {
  seriess[i].hide();
}
seriess[5].show();
seriess[6].show();
} else if (windSpeed < 7.20 && windSpeed > 6.17) {
for (var i = 3; i < 10; i++) {
seriess[i].hide();
}
seriess[6].show();
seriess[7].show();
} else if (windSpeed < 8.23 && windSpeed > 7.20) {
for (var i = 3; i < 10; i++) {
seriess[i].hide();
}
seriess[7].show();
seriess[8].show();
} else if (windSpeed < 10.29 && windSpeed > 8.23) {
for (var i = 3; i < 10; i++) {
seriess[i].hide();
}
seriess[8].show();
seriess[9].show();
} else {
seriess[9].show();
}
//alert(x,y);
});*/


//working random every second
//x = 180*Math.random(); // current time
//y = Math.random();
//series.addPoint([x, y], true, true);

}, 1000);

//update current polar
setInterval(function () {
  var chart = $('#container').highcharts(),
  options = chart.options;
  $.getJSON("/plugins/signalk-polar/windspeed/" + windSpeed + "/interval/" + windRange, function (json) {
    portPolar.length = 0;
    stbPolar.length = 0;
    polarCombined.length = 0;
    json.forEach(function(entry) {
      if(entry['angle'] > 0){
        var windDeg = (entry['angle']/3.14*180);
        var speedKnots = entry['speed']/1852*3600;
        //console.log(windDeg + ',' + speedKnots);
        var polarItem = [windDeg , speedKnots];
        stbPolar.push(polarItem); //positive angles
      }


      if(entry['angle'] < 0){
        var windDeg = (entry['angle']/3.14*180);
        var speedKnots = entry['speed']/1852*3600;
        //console.log(windDeg + ',' + speedKnots);
        var polarItem = [-windDeg , speedKnots];
        portPolar.push(polarItem); //negative angles
      }

      var windDeg = Math.abs(entry['angle']/3.14*180);
      var speedKnots = entry['speed']/1852*3600;
      var polarItem = [windDeg , speedKnots];
      polarCombined.push(polarItem); //combined port and starboard angles



    });
    chart.series[0].setData(portPolar,true);
    chart.series[1].setData(stbPolar,true);
    chart.series[2].setData(polarCombined,true);

    options = chart.options;
  });

}, 5000);



}
}



},

legend: {
  verticalAlign: "middle",
  layout: "vertical"
},

title: {
  align: 'left',
  text: '"S/Y Kristina" live polar chart'
},

subtitle: {
  align: 'center',
  text: windSpeed+' +/-'+windRange+' m/s',
  x: -100
},

pane: {
  center: ["0%", "50%"],
  startAngle: 0,
  endAngle: 180
},

xAxis: {
  tickInterval: 45,
  min: 0,
  max: 180,
  labels: {
    formatter: function () {
      return this.value + '°';
    }
  },
  plotLines: [{
    color: 'red', // Color value
    dashStyle: 'shortdashdot', // Style of the plot line. Default to solid
    value: tackAngle,//getTarget().Tack, // Value of where the line will appear
    width: 2, // Width of the line
    id: 'tack',
    label: {
      text: 'Target tack '+tackAngle+ '°',
      verticalAlign: 'center',
      textAlign: 'center',
      rotation: tackAngle-90,
      x: 90
    }
  },  {
    color: 'red', // Color value
    dashStyle: 'shortdashdot', // Style of the plot line. Default to solid
    value: reachAngle, // Value of where the line will appear
    width: 2, // Width of the line
    id: 'reach', //see http://www.highcharts.com/docs/chart-concepts/plot-bands-and-plot-lines for dynamically updating
    label: {
      text: 'Target reach '+reachAngle+ '°',
      verticalAlign: 'right',
      textAlign: 'top',
      rotation: reachAngle-90,
      x: 20
    }
  }]
},

yAxis: {
  min: 0
},

plotOptions: {
  series: {
    pointStart: 0,
    pointInterval: 45,
    enableMouseTracking: false

  },
  column: {
    pointPadding: 0,
    groupPadding: 0
  },
  spline: { /* or line, area, series, areaspline etc.*/
    marker: {
      enabled: false
    },
    connectNulls: false
  },
  scatter: {
    dataLabels: {
      enabled: true,
      format: '{y:.2f}kn , {x:.1f}°'
    },
    marker: {
      //fillColor: 'transparent',
      lineWidth: 2,
      symbol: 'circle',
      lineColor: null
    }
  }
},

series: [{
  type: 'line',
  name: 'Port',
  color: 'red',
  data: portPolar,
  visible: false,
  connectEnds: false,
  turboThreshold: 0
}, {
  type: 'line',
  name: 'Starboard',
  color: 'green',
  data: stbPolar,
  visible: false,
  connectEnds: false,
  turboThreshold: 0
},{
  type: 'line',
  name: 'Combined port & stbd',
  lineWidth: 5,
  //color: 'blue',
  data: polarCombined,
  connectEnds: false,
  turboThreshold: 0
},{
  type: 'spline',
  name: 'Design 3.09 m/s',
  dashStyle: 'shortdashdot',
  data: polarDesign309,
  visible: true,
  connectEnds: false
},{
  type: 'spline',
  name: 'Design 4.11 m/s',
  dashStyle: 'shortdashdot',
  data: polarDesign411,
  visible: true,
  connectEnds: false
},{
  type: 'spline',
  name: 'Design 5.14 m/s',
  dashStyle: 'shortdashdot',
  data: polarDesign514,
  visible: true,
  connectEnds: false
},{
  type: 'spline',
  name: 'Design 6.17 m/s',
  dashStyle: 'shortdashdot',
  data: polarDesign617,
  visible: true,
  connectEnds: false
},{
  type: 'spline',
  name: 'Design 7.20 m/s',
  dashStyle: 'shortdashdot',
  data: polarDesign720,
  visible: true,
  connectEnds: false
},{
  type: 'spline',
  name: 'Design 8.23 m/s',
  dashStyle: 'shortdashdot',
  data: polarDesign823,
  visible: true,
  connectEnds: false
},{
  type: 'spline',
  name: 'Design 10.29 m/s',
  dashStyle: 'shortdashdot',
  data: polarDesign1029,
  visible: true,
  connectEnds: false
}, {
  type: 'scatter',
  name: 'Current performance',
  color: 'orange',
  data: [current],
}]



});

$('#toggle').click(function () {
  var chart = $('#container').highcharts(),
  options = chart.options;

  options.chart.polar = !options.chart.polar;

  $('#container').highcharts(options);
});

});



</script>


</head>
<body>

  <script src="node_modules/highcharts/highstock.js"></script>
  <script src="node_modules/highcharts/highcharts-more.js"></script>
  <script src="node_modules/highcharts/modules/exporting.js"></script>

  <script type="text/javascript">
  /*$(function(){

  var script = document.createElement("script");
  if (window.location.href.indexOf("night=true") > 0 ){
  script.src = "js/themes/night.js";
  console.log("Good Night");
}
else{
console.log("God morgen");
}
document.body.appendChild(script);

});*/
</script>
<div id="container" style="min-width: 310px; max-width: 800px; height: 600px; margin: 0 auto"></div>

<button id="toggle">Polar/Line chart toggle</button>
<!-- <button id="night">Night Mode</button> -->
</body>


</html>
